@* Giữ nguyên phần đầu của file Home/Index.cshtml *@
@{
    ViewData["title"] = "Home Page";
    // Bỏ biến numOfQuantity = 1 không dùng ở đây
}

@model IEnumerable<WebBanPhuKienDienThoai.Models.Product>

@* Giữ nguyên section Scripts cho phần Compare Products *@
@section Scripts {
    <script>
        // ... code cho compare products giữ nguyên ...
        $(document).ready(function () {
             var selectedProducts = [];
             // ... (handlers cho compare, remove-compare, clear-compare, compare-now) ...
             $('.compare').on('click', function () {
                 var productId = $(this).data('productid');
                 var productName = $(this).data('name');
                 var productImage = $(this).data('image');
                 if (!selectedProducts.some(p => p.id === productId)) {
                     selectedProducts.push({ id: productId, name: productName, image: productImage });
                     updateCompareSection();
                 }
             });

              function updateCompareSection() { /* ... code ... */ }

              $(document).on('click', '.remove-compare', function () { /* ... code ... */ });
              $(document).on('click', '#clear-compare', function () { /* ... code ... */ });
              $(document).on('click', '#compare-now', function () { /* ... code ... */ });
         });
    </script>
}

@* Giữ nguyên phần HTML hiển thị banner, products, blog ... *@
<section class="bg-light py-5">
     </section>
<section class="py-5">
     </section>
<section id="mobile-products" class="py-5">
    <div class="container">
        @foreach (var item in Model.Take(4))
        {
            <div class="col">
                <div class="card h-100">
                     <a asp-controller="Product" asp-action="Display" asp-route-id="@item.Id" >
                         <img src="@item.ImageUrl" class="card-img-top" alt="@item.Name">
                     </a>
                     <div class="card-body">
                         <h5 class="card-title">
                             <a href="@Url.Action("Display", "Product", new { id = item.Id })">@item.Name</a>
                         </h5>
                         <p class="card-text">@item.Price.ToString("#,##0") VND</p>
                         <div class="d-flex align-items-center">
                              @* Sử dụng onclick gọi hàm addToCart đã sửa *@
                             <a href="#" class="btn btn-dark me-2 add-to-cart-btn-global" data-product-id="@item.Id">Add to Cart</a>
                              @* Nút Compare *@
                              <button class="compare btn btn-primary btn-sm"
                                      data-productid="@item.Id"
                                      data-name="@item.Name"
                                      data-image="@item.ImageUrl">
                                  +
                              </button>
                         </div>
                     </div>
                </div>
            </div>
        }
         <div id="compare-section" class="mt-4 d-flex align-items-center flex-wrap gap-3"></div>
    </div>
</section>
@*
   QUAN TRỌNG: Hàm addToCart nên được định nghĩa ở _Layout.cshtml
   hoặc trong một file site.js chung để tránh lặp lại và đảm bảo nó có thể
   truy cập __RequestVerificationToken dễ dàng.
   Tuy nhiên, nếu bạn muốn giữ nó ở đây, hãy đảm bảo _Layout.cshtml có @Html.AntiForgeryToken()
*@

@* Đặt script này vào @section Scripts HOẶC tốt hơn là vào _Layout.cshtml hoặc site.js *@
@* @section Scripts { *@
 @* // Kế thừa script compare từ trên *@
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> @* Đảm bảo jQuery được tải ПРИЗЫ *@
 <script>
    // Hàm lấy token (cần @Html.AntiForgeryToken() trong _Layout.cshtml)
    function getAntiForgeryToken() {
        return $('input[name="__RequestVerificationToken"]').val();
    }

    // Bắt sự kiện click chung cho các nút Add to Cart
    // Sử dụng class 'add-to-cart-btn-global' hoặc class bạn đã dùng ở _Layout
     $(document).on('click', '.add-to-cart-btn-global', function(e) {
         e.preventDefault(); // Ngăn thẻ <a> điều hướng
         var productId = $(this).data('product-id');
         var quantity = 1; // Mặc định số lượng là 1
         var $button = $(this); // Lưu lại button để disable nếu cần

         if (!productId) return; // Thoát nếu không có productId

         $button.prop('disabled', true).text('Adding...'); // (Tùy chọn) Disable nút

         $.ajax({
             url: '@Url.Action("AddToCart", "ShoppingCart")', // URL tới Action
             type: 'POST',
             // Gửi dạng form-urlencoded để tương thích ValidateAntiForgeryToken
             contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
             data: {
                 __RequestVerificationToken: getAntiForgeryToken(), // << GỬI TOKEN
                 productId: productId,
                 quantity: quantity
             },
             dataType: 'json', // Mong đợi JSON
             success: function (response) {
                 if (response.success) {
                     // Cập nhật số lượng trên header (nếu có và action trả về count)
                     if (typeof response.count !== 'undefined') {
                         $('#cart-count').text(response.count); // Cập nhật số trên nút Cart màu vàng
                     }

                     // Hiển thị thông báo
                     alert(response.message);

                     // Tải lại trang SAU KHI người dùng nhấn OK trên alert
                     window.location.reload();

                 } else {
                     // Xử lý lỗi trả về từ server
                     alert("Lỗi: " + response.message);
                     $button.prop('disabled', false).text('Add to Cart'); // Kích hoạt lại nút nếu lỗi
                 }
             },
             error: function (xhr, status, error) {
                 console.error("AJAX Error:", status, error, xhr.responseText);
                 alert("Có lỗi xảy ra khi thêm sản phẩm!");
                 $button.prop('disabled', false).text('Add to Cart'); // Kích hoạt lại nút nếu lỗi
             }
             // Không cần complete vì trang sẽ reload nếu thành công
         });
     });
 </script>
@* } *@